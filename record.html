<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SASO - Clinic Records</title>
<link rel="icon" type="image/png" href="school logo.jpg">
<style>
body { font-family:"Segoe UI",Arial,sans-serif; background:linear-gradient(135deg,#b2f2bb,#d4edda); margin:0; padding:0; }
header { background-color:#155724; color:white; text-align:center; padding:20px 0; font-size:24px; font-weight:bold; box-shadow:0 2px 6px rgba(0,0,0,0.2); position:relative; }
header::after { content:""; display:block; height:6px; width:100%; background:linear-gradient(to right,#00c853,#a5d6a7,#00c853); position:absolute; bottom:0; left:0; }
.container { max-width:1200px; margin:0 auto; padding:20px 15px; }
.records-card { background:white; border-radius:15px; box-shadow:0 4px 10px rgba(0,0,0,0.15); padding:20px; border-left:8px solid #218838; }
h1 { text-align:center; color:#155724; margin-bottom:20px; border-bottom:2px solid #218838; padding-bottom:10px; font-size:22px; font-weight:700; }
.controls { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px; }
.back-btn { background:#28a745; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold; text-decoration:none; display:inline-block; text-align:center; }
.back-btn:hover { background:#218838; }
#searchInput { padding:10px 15px; border:2px solid #9ccc65; border-radius:25px; width:300px; font-size:14px; }
#searchInput:focus { outline:none; border-color:#218838; }
.record-count { color:#155724; font-weight:600; font-size:14px; margin-left:10px; display:block; margin-top:5px; }
.records-table { width:100%; border-collapse:collapse; margin-top:15px; min-width:600px; }
.records-table th, .records-table td { border:1px solid #dee2e6; padding:10px 5px; text-align:left; font-size:13px; }
.records-table th { background:#f8f9fa; color:#155724; font-weight:bold; text-align:center; }
.records-table tr:nth-child(even) { background:#f8f9fa; }
.records-table tr:hover { background:#e9ecef; }
.time-cell { text-align:center; }
.empty-state { text-align:center; padding:40px; color:#6c757d; font-size:16px; }
.message { text-align:center; padding:15px; border-radius:6px; margin-bottom:20px; font-weight:600; display:none; }
.success-message { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
.error-message { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
button.edit-btn { background:#ffc107; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; color:#155724; }
button.edit-btn:hover { background:#e0a800; }
button.delete-btn { background:#dc3545; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; color:white; }
button.delete-btn:hover { background:#c82333; }

/* Modal Styles */
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; padding:10px; overflow-y:auto; }
.modal-content { background:white; padding:20px; border-radius:12px; max-width:500px; width:100%; box-shadow:0 5px 20px rgba(0,0,0,0.3); }
.modal-content h2 { margin-top:0; color:#155724; text-align:center; margin-bottom:15px; font-size:18px; }
.modal-content label { display:block; margin-top:10px; font-weight:600; font-size:14px; }
.modal-content input, .modal-content textarea { width:100%; padding:8px 10px; margin-top:4px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
.modal-content textarea { resize:vertical; min-height:50px; }
.modal-actions { text-align:right; margin-top:15px; display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap; }
.modal-actions button { padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; font-size:14px; flex:1; min-width:100px; }
.save-btn { background:#28a745; color:white; }
.save-btn:hover { background:#218838; }
.cancel-btn { background:#6c757d; color:white; }
.cancel-btn:hover { background:#5a6268; }

/* ===== MOBILE RESPONSIVE ===== */
@media(max-width:768px){
  header { font-size:20px; padding:12px 0; }
  .controls{flex-direction:column;align-items:stretch; gap:10px;}
  #searchInput{width:100%;}
  .record-count{margin-left:0; margin-top:5px;}
  .records-table { display:block; overflow-x:auto; white-space:nowrap; min-width:100%; }
  .records-table th, .records-table td { padding:8px 6px; font-size:12px; }
  button.edit-btn, button.delete-btn { padding:5px 8px; font-size:12px; }
  .records-card { padding:15px; }
  .modal-content { padding:15px; width:100%; max-width:100%; }
  .modal-actions { flex-direction:column; align-items:stretch; }
  .modal-actions button { flex:none; width:100%; }
}
</style>
</style>
</head>
<body>

<header>SCHOOL CLINIC CONSULTATION RECORDS</header>

<div class="container">
  <div class="records-card">
    <h1>CLINIC CONSULTATION RECORDS</h1>
    <div id="message" class="message"></div>
    <div class="controls">
      <a href="index.html" class="back-btn">‚¨Ö Back to Form</a>
      <div>
        <input type="text" id="searchInput" placeholder="üîç Search by Name or Student Number..." onkeyup="filterRecords()" disabled>
        <span id="recordCount" class="record-count"></span>
      </div>
    </div>
    <div id="recordsContainer">
      <div class="empty-state">Connecting to database...</div>
    </div>
  </div>
</div>


<div class="modal" id="editModal">
  <div class="modal-content">
    <h2>Edit Record</h2>
    <form id="editForm">
      <input type="hidden" id="editId">
      <label>Date</label><input type="date" id="editDate" required>
      <label>Name</label><input type="text" id="editName" required>
      <label>Student Number</label><input type="text" id="editSN" required>
      <label>Section</label><input type="text" id="editSection" required>
      <label>Time In</label><input type="time" id="editTimeIn" required>
      <label>Time Out</label><input type="time" id="editTimeOut">
      <label>Complaints</label><textarea id="editComplaints" required></textarea>
      <label>Assessment</label><textarea id="editAssessment" required></textarea>
      <label>Medicine</label><textarea id="editMedicine"></textarea>
      <label>Intervention</label><textarea id="editIntervention"></textarea>
      <label>Personnel</label><input type="text" id="editPersonnel" required>
      <div class="modal-actions">
        <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
        <button type="submit" class="save-btn">Save</button>
      </div>
    </form>
  </div>
</div>

<script type="module">
// Firebase imports remain the same as your previous code
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDtgHPi-wvbsC9ZYZQXtiaZu7Y_ysO7LwA",
  authDomain: "clinicsystem-e2fb2.firebaseapp.com",
  projectId: "clinicsystem-e2fb2",
  storageBucket: "clinicsystem-e2fb2.appspot.com",
  messagingSenderId: "362758307780",
  appId: "1:362758307780:web:22828a5a04f8b97895ae91",
  measurementId: "G-DNL5VQ7872"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const clinicRecordsCollection = collection(db, "clinic_records");

let allRecords = [];
let unsubscribeSnapshot = null;

const messageDiv = document.getElementById('message');
const recordsContainer = document.getElementById('recordsContainer');
const searchInput = document.getElementById('searchInput');

const editModal = document.getElementById('editModal');
const editForm = document.getElementById('editForm');

document.addEventListener('DOMContentLoaded', () => initializeAuth());

async function initializeAuth() {
  try { await signInAnonymously(auth); }
  catch(e){ showMessage('Failed to connect to Firebase.','error'); return; }

  onAuthStateChanged(auth, user => {
    if(user){ searchInput.disabled = false; setupRealtimeListener(); }
    else{ searchInput.disabled = true; }
  });
}

function setupRealtimeListener() {
  if(unsubscribeSnapshot) unsubscribeSnapshot();
  const q = query(clinicRecordsCollection, orderBy('timestamp','desc'));
  unsubscribeSnapshot = onSnapshot(q, snapshot=>{
    allRecords=[];
    snapshot.forEach(doc=>allRecords.push({id:doc.id,...doc.data()}));
    renderRecords(allRecords);
    updateRecordCount(allRecords.length);
  }, error=>{
    console.error(error);
    showMessage('‚ùå Failed to sync records','error');
    recordsContainer.innerHTML='<div class="empty-state">Failed to load records.</div>';
  });
}

function renderRecords(records){
  if(!records.length){ recordsContainer.innerHTML='<div class="empty-state">No records found. Add one from the form!</div>'; return; }
  const tableHTML = `<table class="records-table">
    <thead>
      <tr>
        <th>Date</th><th>Name</th><th>Student Number</th><th>Section</th>
        <th>Time In/Out</th><th>Complaints</th><th>Assessment</th>
        <th>Medicine</th><th>Intervention</th><th>Personnel</th>
        <th>Edit</th><th>Delete</th>
      </tr>
    </thead>
    <tbody>
      ${records.map(r=>{
        const date=new Date(r.date).toISOString().slice(0,10);
        const time=r.time_in + (r.time_out ? ' - '+r.time_out : '');
        return `<tr data-id="${r.id}">
          <td>${date}</td>
          <td>${escapeHtml(r.name)}</td>
          <td>${escapeHtml(r.student_number)}</td>
          <td>${escapeHtml(r.section)}</td>
          <td class="time-cell">${time}</td>
          <td>${escapeHtml(r.complaints)}</td>
          <td>${escapeHtml(r.assessment)}</td>
          <td>${escapeHtml(r.medicine || '')}</td>
          <td>${escapeHtml(r.intervention || '')}</td>
          <td>${escapeHtml(r.personnel)}</td>
          <td><button class="edit-btn" onclick="openEditModal('${r.id}')">‚úèÔ∏è</button></td>
          <td><button class="delete-btn" onclick="deleteRecord('${r.id}')">üóëÔ∏è</button></td>
        </tr>`;
      }).join('')}
    </tbody>
  </table>`;
  recordsContainer.innerHTML = tableHTML;
}

function filterRecords(){
  const term = searchInput.value.toLowerCase();
  const rows = document.querySelectorAll('.records-table tbody tr');
  let visible=0;
  rows.forEach(r=>{
    const name=r.cells[1].textContent.toLowerCase();
    const sn=r.cells[2].textContent.toLowerCase();
    if(name.includes(term) || sn.includes(term)){ r.style.display=''; visible++; }
    else r.style.display='none';
  });
  updateRecordCount(visible,true);
}

function updateRecordCount(count,filtered=false){
  const total=allRecords.length;
  document.getElementById('recordCount').textContent=filtered ? `Showing ${count} of ${total} records` : `Total Records: ${count}`;
}

async function deleteRecord(id){
  if(confirm("Are you sure you want to delete this record?")){
    try{ await deleteDoc(doc(db,"clinic_records",id)); showMessage("Record deleted successfully.","success"); }
    catch(e){ console.error(e); showMessage("Failed to delete record.","error"); }
  }
}

function openEditModal(id){
  const record = allRecords.find(r=>r.id===id);
  if(!record) return;
  document.getElementById('editId').value = record.id;
  document.getElementById('editDate').value = new Date(record.date).toISOString().slice(0,10);
  document.getElementById('editName').value = record.name;
  document.getElementById('editSN').value = record.student_number;
  document.getElementById('editSection').value = record.section;
  document.getElementById('editTimeIn').value = record.time_in;
  document.getElementById('editTimeOut').value = record.time_out || '';
  document.getElementById('editComplaints').value = record.complaints;
  document.getElementById('editAssessment').value = record.assessment;
  document.getElementById('editMedicine').value = record.medicine || '';
  document.getElementById('editIntervention').value = record.intervention || '';
  document.getElementById('editPersonnel').value = record.personnel;
  editModal.style.display = 'flex';
}

editForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const id = document.getElementById('editId').value;
  try{
    await updateDoc(doc(db,'clinic_records',id), {
      date: document.getElementById('editDate').value,
      name: document.getElementById('editName').value,
      student_number: document.getElementById('editSN').value,
      section: document.getElementById('editSection').value,
      time_in: document.getElementById('editTimeIn').value,
      time_out: document.getElementById('editTimeOut').value,
      complaints: document.getElementById('editComplaints').value,
      assessment: document.getElementById('editAssessment').value,
      medicine: document.getElementById('editMedicine').value,
      intervention: document.getElementById('editIntervention').value,
      personnel: document.getElementById('editPersonnel').value
    });
    closeModal();
    showMessage("Record updated successfully.","success");
  }catch(e){ console.error(e); showMessage("Failed to update record.","error"); }
});

function closeModal(){ editModal.style.display='none'; }
function showMessage(text,type){ messageDiv.textContent=text; messageDiv.className=`message ${type}-message`; messageDiv.style.display='block'; setTimeout(()=>messageDiv.style.display='none',3000);}
function escapeHtml(str){ const div=document.createElement('div'); div.textContent=str; return div.innerHTML;}
window.openEditModal = openEditModal;
window.deleteRecord = deleteRecord;
window.addEventListener('beforeunload', ()=>{ if(unsubscribeSnapshot) unsubscribeSnapshot(); });
</script>
</body>
</html>
